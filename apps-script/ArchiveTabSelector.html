<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    body { font-family: sans-serif; margin: 10px; }
    .container { margin-bottom: 10px; }
    .tab-item { margin-bottom: 5px; }
    button { padding: 8px 15px; background-color: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; }
    button:hover { background-color: #45a049; }
    button:disabled { background-color: #cccccc; cursor: not-allowed; }
    #message { margin-top: 10px; color: green; font-weight: bold; }
    #error-message { margin-top: 10px; color: red; font-weight: bold; }
  </style>
</head>
<body>
  <h2>Select Tabs to Archive</h2>
  <p>The script will search for new emails matching the selected tabs and update their content.</p>
  <div class="container" id="tabListContainer">
    <p>Loading tabs...</p>
  </div>
  <button id="archiveButton" onclick="archiveSelectedTabs()" disabled>Archive Selected Tabs</button>
  <div id="message"></div>
  <div id="error-message"></div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      google.script.run.withSuccessHandler(displayTabs)
                       .withFailureHandler(showError)
                       .getTabNamesForUI();
    });

    function displayTabs(tabNames) {
      const container = document.getElementById('tabListContainer');
      container.innerHTML = ''; // Clear "Loading tabs..."
      if (tabNames.length === 0) {
        container.innerHTML = '<p>No tabs found in the document.</p>';
        document.getElementById('archiveButton').disabled = true;
        return;
      }

      tabNames.forEach(name => {
        const div = document.createElement('div');
        div.className = 'tab-item';
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = 'tab_' + encodeURIComponent(name); // Use encoded name for ID
        checkbox.name = 'selectedTabs';
        checkbox.value = name;
        
        const label = document.createElement('label');
        label.htmlFor = 'tab_' + encodeURIComponent(name);
        label.textContent = name;
        
        div.appendChild(checkbox);
        div.appendChild(label);
        container.appendChild(div);
      });
      document.getElementById('archiveButton').disabled = false;
    }

    function archiveSelectedTabs() {
      const selectedCheckboxes = document.querySelectorAll('input[name="selectedTabs"]:checked');
      const selectedTabNames = Array.from(selectedCheckboxes).map(cb => cb.value);

      if (selectedTabNames.length === 0) {
        document.getElementById('message').textContent = '';
        document.getElementById('error-message').textContent = 'Please select at least one tab.';
        return;
      }

      document.getElementById('archiveButton').disabled = true;
      document.getElementById('message').textContent = 'Archiving for selected tabs... This may take a moment.';
      document.getElementById('error-message').textContent = '';

      google.script.run.withSuccessHandler(google.script.host.close) // Close dialog on success
                       .withFailureHandler(showError)
                       .runArchiveForSpecificTabs(selectedTabNames);
    }

    function showError(error) {
      document.getElementById('error-message').textContent = 'Error: ' + error.message;
      document.getElementById('message').textContent = '';
      document.getElementById('archiveButton').disabled = false; // Re-enable button on error
      console.error(error);
    }
  </script>
</body>
</html>